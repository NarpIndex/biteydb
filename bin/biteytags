#!/usr/bin/env ruby
require 'json'
require 'open-uri'
require 'fileutils'
require 'time'

BITEY_DIR = '/usr/bitey'
SOFTWARE_DIR = File.join(BITEY_DIR, 'software')
PROJECT_DIR = File.join(BITEY_DIR, 'project')
PATHS_FILE = File.join(PROJECT_DIR, 'bitey_paths')
RC_FILE = File.join(PROJECT_DIR, 'biteyrc')
TAG_DB_BASE = 'https://raw.githubusercontent.com/NarpIndex/biteydb-data/main/tags'

# Create software directory if needed
FileUtils.mkdir_p(SOFTWARE_DIR) unless Dir.exist?(SOFTWARE_DIR)

def run_cmd(command)
  success = system(command)
  code = $?.exitstatus

  unless success
    puts "\n❌ Command failed: #{command} (exit code: #{code})"
    exit code
  end
end

def git_with_progress(url, dest, name)
  puts "⬇️  Cloning #{name} from #{url}..."
  run_cmd("git clone --quiet #{url} #{dest}")
  puts "✅ Installed #{name}"
end

def fetch_tag(tag)
  tag_url = "#{TAG_DB_BASE}/#{tag}.json"
  begin
    puts "🌐 Fetching tag data for '#{tag}'..."
    json = URI.open(tag_url).read
    JSON.parse(json)
  rescue OpenURI::HTTPError => e
    puts "❌ Failed to fetch tag data: #{e.message}"
    exit 1
  rescue JSON::ParserError => e
    puts "❌ Failed to parse JSON for tag '#{tag}': #{e.message}"
    exit 1
  end
end

def install(tag)
# ---- Tag install logic ----
tag_data = fetch_tag(tag)

puts "---"
tag_data.each do |name, url|
  dest_dir = File.join(SOFTWARE_DIR, name)
  if Dir.exist?(dest_dir)
    puts "🔁 #{name} already exists. Skipping..."
    next
  end

  git_with_progress(url, dest_dir, name)
  install_script = File.join(dest_dir, 'project', 'install.sh')
  if File.exist?(install_script)
    system("bash", install_script)
  end
  File.open(PATHS_FILE, 'a') { |f| f.puts dest_dir }
  File.open(RC_FILE, 'a') { |f| f.puts File.join(dest_dir, 'bin') }
end
puts "---"
puts "🎉 All components from tag '#{tag}' installed to #{SOFTWARE_DIR}"
end

def remove(tag)
  tag_data = fetch_tag(tag)
  puts "---"
  tag_data.each do |name, _|
    puts "🗑️ Removing #{name}..."
    run_cmd("sudo bitey remove --noconfirm #{name}")
  end
  puts "---"
  puts "🧹 All components from tag '#{tag}' have been removed."
end

# ---- Argument handling ----
if ARGV.length == 0
  puts "Usage:"
  puts "  sudo biteytags install <tag>"
  puts "  sudo biteytags remove <tag>"
  exit 1
end

if ARGV[0] == 'install' && ARGV.length >= 2
  tag = ARGV[1]
  install(tag)
elsif ARGV[0] == 'remove' && ARGV.length >= 2
  tag = ARGV[1]
  remove(tag)
else
  puts "❌ Invalid syntax."
  puts "Usage:"
  puts "  sudo biteytags install <tag>"
  puts "  sudo biteytags remove <tag>"
  exit 1
end
